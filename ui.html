<div>
    <!-- <div id="top-row">
        Mode:
        <button class="mode active" id="mode-1" onclick="selectMode('mode-1')">
            tag
        </button>
        <button class="mode" id="mode-2" onclick="selectMode('mode-2')">
            select
        </button>
        <button class="mode" id="mode-3" onclick="selectMode('mode-3')">
            section
        </button>
    </div> -->
    <div id="input-row">
        <input id="tag-label" />
        <button id="add-tag">
            Add tag
        </button>
    </div>
    <p id="error-message"></p>
    <h2>Tags:</h2>

    <div id="tags">
    </div>
    <h2>Create Sections:</h2>
    <div class="button-row" id="bottom-buttons">
        <!-- <button id="section-all" class="primary">Section <b>all</b> Sticky Notes by tag</button> -->
        <button id="section-tags" class="primary" onclick="sectionByTag()">Section selected Sticky Notes <b>by
                tag</b></button>
    </div>
</div>

<script>
    var back = " #]"
    var front = "[# "

    // Press enter to trigger 'Add tag' button'
    document.getElementById("tag-label").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            document.getElementById("add-tag").click();
        }
    });

    // Add Tag through input
    document.getElementById("add-tag").onclick = () => {
        var tag = document.getElementById("tag-label").value
        var errorMsg = document.getElementById("error-message")

        // Check if valid (non-empty, stickies selected)
        if (tag.trim() === "") {
            errorMsg.innerHTML = "A tag cannot be empty"
            return
        }

        if (tag.includes(front) || tag.includes(back)) {
            errorMsg.innerHTML = `A tag cannot include special characters '${front}' or '${back}'`
            return
        }

        parent.postMessage({
            pluginMessage: {
                type: "check-selected",
            }
        }, "*")

    }

    function sectionByTag() {
        parent.postMessage({
            pluginMessage: {
                type: "section-tag",
            }
        }, "*")
    }

    // function selectMode(id) {
    //     if (mode !== id) {
    //         document.getElementById('mode-1').classList.remove('active')
    //         document.getElementById('mode-2').classList.remove('active')
    //         document.getElementById('mode-3').classList.remove('active')
    //         document.getElementById(id).classList.add('active')
    //         mode = id
    //         parent.postMessage({
    //             pluginMessage: {
    //                 type: "change-mode",
    //                 mode: id,
    //             }
    //         }, "*")
    //     }
    // }


    function triggerTag(tagName, onSticky) {
        console.log("Trigger", tagName)
        if (onSticky) {
            parent.postMessage({
                pluginMessage: {
                    type: "remove-tag",
                    tag: tagName,
                }
            }, "*")

        } else {
            parent.postMessage({
                pluginMessage: {
                    type: "add-tag",
                    tag: tagName,
                }
            }, "*")
        }
    }


    function initTagsList(tags) {
        var tagsList = document.querySelector("#tags")

        // Clear tagsList
        tagsList.innerHTML = ""

        // Tag mode
        for (const tag of tags) {
            tagsList.insertAdjacentHTML("beforeend",
                `<div class='tag ${tag.onSticky ? '' : 'disabled'}'>
                    <div class='title' onclick="triggerTag('${tag.tagName}', ${tag.onSticky})"">${tag.tagName}</div>
                </div>`
            );
        }

    }

    // Catch messages pushed from code.js
    onmessage = (event) => {
        if (event.data.pluginMessage.msg === "init") {
            var tags = event.data.pluginMessage.tags
            initTagsList(tags)

        } else if (event.data.pluginMessage.msg === "valid") {
            var tag = document.getElementById("tag-label").value
            var errorMsg = document.getElementById("error-message")

            parent.postMessage({
                pluginMessage: {
                    type: "add-tag",
                    tag: tag,
                }
            }, "*")

            document.getElementById("tag-label").value = ""
            errorMsg.innerHTML = ""

        } else if (event.data.pluginMessage.msg === "invalid") {
            var errorMsg = document.getElementById("error-message")
            errorMsg.innerHTML = "You must select a sticky note before you add a tag"

        }

    }
</script>


<style>
    /* GLOBAL */

    * :focus {
        outline-color: blueviolet;
    }

    body {
        max-width: 100%;
        background-color: #F6F7FC;

    }

    /* TOP SECTION */

    h2 {
        font-family: Arial;
        font-size: 20px;
        font-style: normal;
    }

    #tag-label {
        height: 36px;
        padding-left: 8px;
        font-family: Arial;
        font-size: 16px;
        font-style: normal;
        width: 100%;

    }

    #add-tag,
    .primary {
        height: 36px;
        font-family: Arial;
        font-size: 16px;
        font-style: normal;
        background-color: black;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0 16px;
        white-space: nowrap;
        cursor: pointer;

    }

    .primary {
        width: 100%;

    }

    #input-row {
        display: flex;
        gap: 8px;
        width: 100%;
        align-items: stretch;
    }

    #error-message {
        margin-top: 12px;
        font-family: Arial;
        font-size: 12px;
        font-weight: 600;
        font-style: normal;
        color: red;
    }

    /* TAGS BLOCK */

    #tags,
    .button-row {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        max-width: 100%;
        align-items: center;

        padding: 12px 0;
        border-top: 1px solid black;
    }

    #tags {
        min-height: 36px;
    }


    .title {
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }


    .title:hover {
        filter: brightness(115%);

    }

    .tag {
        display: flex;
        align-items: center;
        max-width: 100%;
    }

    .title {
        font-family: Arial;
        font-size: 16px;
        font-style: normal;
        height: 36px;

        display: flex;
        align-items: center;

        background-color: blueviolet;
        color: white;

        padding: 0 8px;
        height: 36px;
        border-radius: 4px;

        white-space: nowrap;
        max-width: 100%;
        overflow: scroll;
        text-overflow: ellipsis;

    }

    .disabled {
        filter: brightness(70%);
    }

    /* TOP ROW */
    #top-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding-bottom: 8px;
        margin-top: 0;
        /* border-bottom: 1px solid black; */
        margin-bottom: 12px;

        font-weight: 600;

    }

    #top-row {
        font-family: Arial;
        font-size: 16px;
        font-style: normal;
        color: black;
    }
</style>